---
title: "rice_oxi"
author: "Chosen_Obih"
date: "2023-12-19"
output: html_document
---
load required libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.show = 'asis')
library(tidyverse)
library(ggplot2)
library(ggalt)
library(ggbiplot)
library(ComplexHeatmap)
```

set working dir and read-in data
```{r}
setwd("/home/chosen/Desktop/Rice_GWAS_project/data/")
oxi_data <- read.csv("oxi_data.csv", header = TRUE)
```

# transform data format from wide to long
```{r}
oxi_data_long <- oxi_data %>%
  pivot_longer("GOX":"ProtOx", names_to = "Oxidative_stress", values_to = "Value")
```

Density plot
```{r echo=FALSE, fig.height=12, fig.show='asis', fig.width=15}
ggplot(oxi_data_long, aes(x = Value, fill = Treatment)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("#00AFBB", "#FC4E07")) +
  facet_wrap(~ Oxidative_stress, scales = "free") +
  labs(title = "Density plots of oxidative stress parameters by treatment groups",
       x = "Value",
       y = "Density") +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

Create a separate plot for each oxidative stress parameter. There must be a more convenient way to make this separate plots. I will check.
```{r plot1, echo=FALSE, fig.cap="Ascorbate Oxidase"}
ggplot(oxi_data_long, aes(x = Value, fill = Treatment)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("#00AFBB", "#FC4E07")) +
  labs(title = "Density plot for Ascorbate oxidase",
      x = "Value",
       y = "Density") +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

Box plot
```{r fig.height=12, fig.width=12}
box_color <- c("CON" = "#00AFBB", "DRO" = "#FC4E07")

ggplot(oxi_data_long, aes(x = Treatment, y = Value, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_manual(values = box_color) +
  facet_wrap(~ Oxidative_stress, scales = "free") +
  labs(title = "Boxplot of Oxidative Stress Parameters by Treatment Groups",
       x = "Treatment Group",
       y = "Value") +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

PCA
```{r}
# Select only numerical columns for PCA (excluding ID and Treatment columns)
oxi_data_pca <- oxi_data[,4:ncol(oxi_data)]
# Perform PCA
pca <- prcomp(oxi_data_pca, scale. = TRUE)
# Get the summary of PCA to extract explained variance
pca_summary <- summary(pca)
# Extracting the proportion of variance explained by PC1 and PC2
pc1_variance <- pca_summary$importance[2,1] * 100  # PC1 variance percentage
pc2_variance <- pca_summary$importance[2,2] * 100  # PC2 variance percentage
# Create a data frame for the plot
plot_data <- data.frame(Treatment = oxi_data$Treatment, PC1 = pca$x[,1], PC2 = pca$x[,2])
# Define colours for treatment
pca_color <- c("CON" = "#00AFBB", "DRO" = "#FC4E07")
# Plot
ggplot(plot_data, aes(x = PC1, y = PC2, color = Treatment, label = rownames(plot_data))) +
    geom_point() +
    geom_hline(yintercept = 0, lty = 2) +
    geom_vline(xintercept = 0, lty = 2) +
    stat_ellipse(type = "norm",      # Type of ellipse, "norm" assumes a normal-distribution
                 level = 0.95,    # Confidence level for the ellipse
                 aes(group = Treatment)) +
    scale_color_manual(values = pca_color) +
    ggtitle("PCA plot of oxidative stress data") +
    xlab(paste("PC 1 - ", round(pc1_variance, 2), "% Variance")) +
    ylab(paste("PC 2 - ", round(pc2_variance, 2), "% Variance")) +
    theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent"))
```

PCA Loading plot
```{r fig.height=6, fig.width=8}
# Extract loading data
loadings <- pca$rotation[, 1:2]  # Get loading for the first two PCs
# Convert to data frame for plotting
loadings_df <- as.data.frame(loadings)
loadings_df$variable <- rownames(loadings)
# Plot
ggplot(loadings_df, aes(x = PC1, y = PC2, label = variable)) +
    geom_text(vjust = 1, hjust = 1) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_minimal() +
    ggtitle("PCA Loadings Plot") +
    xlab(paste("PC 1 - ", round(pc1_variance, 2), "% Variance")) +
    ylab(paste("PC 2 - ", round(pc2_variance, 2), "% Variance")) +
    theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank())
```

PCA Loading plot 2
```{r}
pca_loading <- autoplot(pca, data = oxi_data, colour = 'Treatment', loadings = TRUE,
              loadings.label = TRUE, loadings.label.size = 3,
              frame = TRUE, frame.type = 'norm', frame.alpha = 0)
# Now add the manual color scale
pca_loading <- pca_loading + scale_color_manual(values = pca_color) +
                  theme(panel.border = element_rect(color = "black", size = 1, fill = NA),
                    panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank())
# Plot
print(pca_loading)
```

Read in physiological data file and merge with oxi_data.csv
```{r fig.height=12, fig.width=12}
#Load physiological data file and add the GYLOSS column to the oxi_data dataframe
phy_data <- read.csv("/home/chosen/Desktop/Rice_GWAS_project/data/physiological_data.csv", header = TRUE)
oxi_data_GYLOSS <- oxi_data
if(nrow(oxi_data_GYLOSS) == nrow(phy_data)) {
  oxi_data_GYLOSSf$GYLOSS <- phy_data$GYLOSS
} else {
  oxi_data_GYLOSS <- left_join(oxi_data_GYLOSS, phy_data %>% select(IRGC, GYLOSS), by = "IRGC")
}
write.csv(oxi_data_GYLOSS, "/home/chosen/Desktop/Rice_GWAS_project/data/oxi_data_GYLOSS.csv", row.names = FALSE)
```

PCA of oxidative stress parameters and percentage grain yield loss (oxi_data_GYLOS)
```{r}
oxi_data_GYLOSS$GYLOSS <- as.numeric(as.character(oxi_data_GYLOSS$GYLOSS))
data_pca <- select(oxi_data_GYLOSS, GOX:GYLOSS)
# Perform PCA
pca_result <- prcomp(data_pca, center = TRUE, scale. = TRUE)
# Get the summary of PCA to extract explained variance
pca_summary_2 <- summary(pca)
# Extracting the proportion of variance explained by PC1 and PC2
pc1_variance_2 <- pca_summary_2$importance[2,1] * 100  # PC1 variance percentage
pc2_variance_2 <- pca_summary_2$importance[2,2] * 100  # PC2 variance percentage
# Create a data frame for plotting
pca_data <- data.frame(pca_result$x, Treatment = oxi_data_GYLOSS$Treatment, GYLOSS = oxi_data_GYLOSS$GYLOSS)
# Create a combined factor for coloring
pca_data$ColorFactor <- ifelse(pca_data$Treatment == "DRO", 
                               paste("DRO -", cut(pca_data$GYLOSS, breaks = 5)),
                               as.character(pca_data$Treatment))

# Define colors for each factor level
color_values <- c("#00AFBB", "#FC4E07", "green", "orange", "purple", "pink")

# Plot
ggplot(pca_data, aes(x = PC1, y = PC2, color = ColorFactor)) +
  geom_point() +
  stat_ellipse(type = "norm",      # Type of ellipse, "norm" assumes a normal-distribution
                 level = 0.95,    # Confidence level for the ellipse
                 aes(group = Treatment)) +
  scale_color_manual(values = color_values) +
  theme_minimal() +
  ggtitle("PCA Plot of Oxi Stress with DRO coloured based on %GYLOSS") +
    xlab(paste("PC 1 - ", round(pc1_variance_2, 2), "% Variance")) +
    ylab(paste("PC 2 - ", round(pc2_variance_2, 2), "% Variance")) +
    theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(), 
        panel.border = element_rect(fill= "transparent"))
```

Correlation matrix analysis (oxi_data only)
```{r fig.height=8, fig.width=8}
# Subset data for each treatment
data_CON <- subset(oxi_data, Treatment == "CON")
data_DRO <- subset(oxi_data, Treatment == "DRO")
# Select the last 20 columns for correlation
data_CON_selected <- data_CON[, (ncol(data_CON)-19):ncol(data_CON)]
data_DRO_selected <- data_DRO[, (ncol(data_DRO)-19):ncol(data_DRO)]
# Calculate correlation matrices
corr_CON <- cor(data_CON_selected, use = "complete.obs")
corr_DRO <- cor(data_DRO_selected, use = "complete.obs")

# Plot correlation matrices
# For CONTROL treatment
test_CON = cor.mtest(corr_CON, conf.level = 0.95)
par(mar = c(5, 4, 2, 2) + 0.1)
corrplot(corr_CON, p.mat = test_CON$p, method = 'color', diag = FALSE, type = 'upper',
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.9,
         insig = 'label_sig', pch.col = 'grey20', order = 'AOE', tl.col = "black", tl.srt = 45, tl.cex = 0.6)
mtext("Correlation matrix between the oxidative_stres parameters under control", side = 4, line = 1, cex = 1)

# For the DROUGHT treatment
test_DRO = cor.mtest(corr_CON, conf.level = 0.95)
par(mar = c(5, 4, 2, 2) + 0.1)
corrplot(corr_DRO, p.mat = test_CON$p, method = 'color', diag = FALSE, type = 'upper',
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.9,
         insig = 'label_sig', pch.col = 'grey20', order = 'AOE', tl.col = "black", tl.srt = 45, tl.cex = 0.6)
mtext("Correlation matrix between the oxidative_stres parameters under drought", side = 4, line = 1, cex = 1)
```

Correlation matrix (oxi_data_GYLOSS)
```{r fig.height=8, fig.width=8}
# Subset data for each treatment
data_CON <- subset(oxi_data_GYLOSS, Treatment == "CON")
data_DRO <- subset(oxi_data_GYLOSS, Treatment == "DRO")

# Select the last 20 columns for correlation
data_CON_selected <- data_CON[, (ncol(data_CON)-20):ncol(data_CON)]
data_DRO_selected <- data_DRO[, (ncol(data_DRO)-20):ncol(data_DRO)]

# Calculate correlation matrices
corr_CON <- cor(data_CON_selected, use = "complete.obs")
corr_DRO <- cor(data_DRO_selected, use = "complete.obs")

# Plot correlation matrices
# For CONTROL treatment
test_CON = cor.mtest(corr_CON, conf.level = 0.95)
par(mar = c(5, 4, 2, 2) + 0.1)
corrplot(corr_CON, p.mat = test_CON$p, method = 'color', diag = FALSE, type = 'upper',
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.9,
         insig = 'label_sig', pch.col = 'grey20', order = 'AOE', tl.col = "black", tl.srt = 45, tl.cex = 0.6)
mtext("Correlation matrix between the oxidative_stres parameters & GYLOSS under control", side = 4, line = 1, cex = 1)

# For the DROUGHT treatment
test_DRO = cor.mtest(corr_CON, conf.level = 0.95)
par(mar = c(5, 4, 2, 2) + 0.1)
corrplot(corr_DRO, p.mat = test_CON$p, method = 'color', diag = FALSE, type = 'upper',
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.9,
         insig = 'label_sig', pch.col = 'grey20', order = 'AOE', tl.col = "black", tl.srt = 45, tl.cex = 0.6)
mtext("Correlation matrix between the oxidative_stres parameters & GYLOSS under drought", side = 4, line = 1, cex = 1)
```


Test for normality of data before doing paired t-test
```{r}
 #Initialize a list to store results
normality_results <- list()

# Loop through the last 20 variables
for (variable in tail(names(data), 20)) {
  # Extract 'CON' and 'DRO' data for the variable
  con_data <- data[data$Treatment == 'CON', c('IRGC', variable)]
  dro_data <- data[data$Treatment == 'DRO', c('IRGC', variable)]
  merged_data <- merge(con_data, dro_data, by = 'IRGC')
  
  # Calculate differences
  differences <- merged_data[,3] - merged_data[,2]
  
  # Shapiro-Wilk normality test on the differences
  shapiro_test <- shapiro.test(differences)
  
  # Store results
  normality_results[[variable]] <- list(
    variable = variable,
    shapiro_p_value = shapiro_test$p.value,
    is_normal = shapiro_test$p.value > 0.05
  )
}
# Convert the list of results to a data frame
normality_results_df <- do.call(rbind, lapply(normality_results, function(x) unlist(x)))

# Print the normality test results
print(normality_results_df)
```


```{r fig.height=6, fig.width=10}
# Perform T-tests
t_test_results <- data.frame(Parameter = character(), P_Value = numeric(), stringsAsFactors = FALSE)
for(param in names(data)[4:length(data)]) {
  t_test <- t.test(data[data$Treatment == 'CON', param], 
                   data[data$Treatment == 'DRO', param])
  t_test_results <- rbind(t_test_results, data.frame(Parameter = param, P_Value = t_test$p.value))
}

# Visualize the results
ggplot(t_test_results, aes(x = Parameter, y = P_Value)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  coord_flip() +
  geom_hline(yintercept = 0.05, linetype = "dashed", color = "red") +
  labs(title = "T-test P-Values for Each Oxidative Stress Parameter", 
       x = "Oxidative Stress Parameter", 
       y = "P-Value")

```

```{r fig.height=10, fig.width=12}
data <- oxi_data

# Prepare the data matrix with the measurements
# Excluding the first three columns which contain the ID, designation, and treatment
data_matrix <- as.matrix(data[, -(1:3)])
rownames(data_matrix) <- data$DESIGNATION

# Create a vector for the treatments that matches the number of columns in the data matrix
treatments_vector <- as.character(data$Treatment)

# Replace "CON" and "DRO" with the actual treatment names
treatments <- factor(treatments_vector, levels = unique(treatments_vector))

# Check if the number of treatments matches the number of columns in the data matrix
if (length(treatments) != ncol(data_matrix)) {
  stop("The number of treatments does not match the number of columns in the data matrix.")
}

# Define colors for the treatments
treatment_colors <- c("CON" = "blue", "DRO" = "red") # Replace with actual treatment names and desired colors

# Create a HeatmapAnnotation object for the top annotations
top_annotation <- HeatmapAnnotation(
  Treatment = treatments,
  col = list(Treatment = treatment_colors)
)

# Define the color mapping for the data values
my_col <- colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))

# Create the heatmap
heatmap_result <- Heatmap(
  data_matrix,
  name = "value",
  col = my_col,
  top_annotation = top_annotation,
  show_row_names = TRUE,
  show_column_names = TRUE,
  clustering_distance_rows = "euclidean",
  clustering_distance_columns = "euclidean",
  clustering_method_rows = "complete",
  clustering_method_columns = "complete"
)

draw(heatmap_result, heatmap_legend_side = "bot", annotation_legend_side = "bot")
```

```{r}
data <- oxi_data

data_CON <- subset(data, Treatment == "CON")
data_DRO <- subset(data, Treatment == "DRO")

data_CON_matrix <- matrix(data_CON[, -(1:3)])
data_DRO_matrix <- matrix(data_DRO[, -(1:3)])

#rownames(data_CON_matrix) <- data_CON$IRGC
#rownames(data_DRO_matrix) <- data_DRO$IRGC

squared_data_DRO_matrix <- squarematrix(data_DRO_matrix) # I tried to transpose the matrix. I didn't like the layout.
squared_data_CON_matrix <- squarematrix(data_CON_matrix)
#Heatmap(data_CON_matrix)
#Heatmap(data_DRO_matrix)

#col_fun = colorRamp2(c(-4, 0, 4), c("green", "white", "red")) #For setting the color of the heatmap
#col_fun(seq(-3, 3)) #For setting the color of the heatmap 'col = col_fun should be added to the Heatmap object in order to apply this setting.

Heatmap(squared_data_DRO_matrix, name = "DROUGHT", clustering_distance_rows = "pearson", column_title = "Hierrachial clustering of oxidative stress values under drought", row_title = "Oxi_data", row_dend_width = unit(2, "cm"), column_dend_height = unit(3, "cm"), show_column_names = FALSE)

Heatmap(squared_data_CON_matrix, name = "CONTROL", clustering_distance_rows = "pearson", column_title = "Hierrachial clustering of oxidative stress values under control", row_title = "Oxi_data", row_dend_width = unit(2, "cm"), column_dend_height = unit(3, "cm"), show_column_names = FALSE)
```


```{r fig.height=8, fig.width=12}
data <- oxi_data

data_CON <- subset(data, Treatment == "CON")
data_DRO <- subset(data, Treatment == "DRO")


data_CON_matrix <- as.matrix(data_CON[, -(1:3)])
data_DRO_matrix <- as.matrix(data_DRO[, -(1:3)])

#rownames(data_CON_matrix) <- data_CON$IRGC
#rownames(data_DRO_matrix) <- data_DRO$IRGC

transposed_data_DRO_matrix <- t(data_DRO_matrix) # I tried to transpose the matrix. I didn't like the layout.
transposed_data_CON_matrix <- t(data_CON_matrix)
#Heatmap(data_CON_matrix)
#Heatmap(data_DRO_matrix)

#col_fun = colorRamp2(c(-4, 0, 4), c("green", "white", "red")) #For setting the color of the heatmap
#col_fun(seq(-3, 3)) #For setting the color of the heatmap 'col = col_fun should be added to the Heatmap object in order to apply this setting.

Heatmap(transposed_data_DRO_matrix, name = "DROUGHT", clustering_distance_rows = "pearson", column_title = "Hierrachial clustering of oxidative stress values under drought", row_title = "Oxi_data", row_dend_width = unit(2, "cm"), column_dend_height = unit(3, "cm"), show_column_names = FALSE)

Heatmap(transposed_data_CON_matrix, name = "CONTROL", clustering_distance_rows = "pearson", column_title = "Hierrachial clustering of oxidative stress values under control", row_title = "Oxi_data", row_dend_width = unit(2, "cm"), column_dend_height = unit(3, "cm"), show_column_names = FALSE)

```

